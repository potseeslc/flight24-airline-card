ttype: custom:html-template-card
card_mod:
  style: |
    ha-card {
      background: #0b0d0f;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.35);
      color: #e5e7eb;
    }
ignore_line_breaks: true
entities:
  - sensor.flightradar24_current_in_area
  - sensor.flightradar24_most_tracked
content: >
  {% set fallback_icon = '/local/assets/fallback-airline/icon.png' %}
  {% set private_icon  = '/local/assets/private-plane/private-plane.png' %}

  {# --------------------------------------------------------
     LOAD FLIGHTS SAFELY
     -------------------------------------------------------- #}

  {% set local = state_attr('sensor.flightradar24_current_in_area', 'flights') or [] %}
  {% set local_filtered = [] %}

  {% for fl in local %}
    {% if fl.get('altitude',0) > 10000 and fl.get('distance') is not none %}
      {% set _ = local_filtered.append(fl) %}
    {% endif %}
  {% endfor %}

  {% if local_filtered %}
    {% set mode = 'local' %}
    {% set f = (local_filtered | sort(attribute='distance'))[0] %}
  {% else %}
    {% set mode = 'most' %}
    {% set most = state_attr('sensor.flightradar24_most_tracked', 'flights') or [] %}
    {% set f = most[0] if most else None %}
  {% endif %}

  <div style="display:flex;flex-direction:column;gap:18px;">

  {% if not f %}
    <div style="font-size:20px;opacity:0.7;">No flights available ✈️</div>
  {% else %}

    {% set fn       = (f.get('flight_number','') | string) %}
    {% set cs       = (f.get('callsign','') | string) %}
    {% set airline  = (f.get('airline_short','Unknown') | string) %}
    {% set airline_l= airline | lower %}
    {% set origin   = f.get('airport_origin_city','Unknown') %}
    {% set dest     = f.get('airport_destination_city','Unknown') %}
    {% set alt      = f.get('altitude',0) %}
    {% set gs       = f.get('ground_speed',0) %}
    {% set aircraft = f.get('aircraft_type')
                      or f.get('aircraft_model')
                      or f.get('aircraft_code')
                      or 'Unknown' %}

    {% if mode == 'local' %}
      {% set dist   = (f.get('distance',0) | float | round(1)) %}
      {% set header = 'Closest flight • ' ~ dist ~ ' km from home' %}
    {% else %}
      {% set header = 'Most tracked flight on Flightradar24' %}
    {% endif %}

    {# --- ICAO LOGO LOOKUP ------------------------------------------------- #}

    {% set logo_url = fallback_icon %}
    {% set icao = '' %}

    {% if cs|length >= 3 %}
      {% set icao = cs[:3] | upper %}
    {% elif fn|length >= 3 %}
      {% set icao = fn[:3] | upper %}
    {% endif %}

    {% if icao %}
      {% set logo_url = '/local/assets/flightaware_logos/' ~ icao ~ '.png' %}
    {% endif %}

    {% if fn.startswith('N') or cs.startswith('N') %}
      {% set logo_url = private_icon %}
      {% set airline_label = 'Private Aircraft' %}
    {% else %}
      {% if airline_l == 'unknown' %}
        {% set airline_label = icao if icao else 'Unknown Airline' %}
      {% else %}
        {% set airline_label = airline %}
      {% endif %}
    {% endif %}

    {# --------------------------------------------------------
       CARD LAYOUT
       -------------------------------------------------------- #}

    <div style="
      display:grid;
      grid-template-columns:1fr auto;
      gap:24px;
      align-items:center;
    ">

      <div style="display:flex;flex-direction:column;gap:10px;">
        <div style="font-size:12px;opacity:0.65;letter-spacing:0.1em;text-transform:uppercase;">
          {{ header }}
        </div>

        <div style="font-size:40px;font-weight:600;">
          {{ fn if fn else cs }}
        </div>

        <div style="font-size:18px;opacity:0.8;">
          {{ cs }}
        </div>

        <div style="font-size:22px;opacity:0.9;margin-top:4px;">
          {{ origin }} → {{ dest }}
        </div>

        <div style="display:flex;gap:28px;margin-top:8px;flex-wrap:wrap;font-size:14px;">

          <div>
            <div style="font-size:11px;opacity:0.6;text-transform:uppercase;">Altitude</div>
            <div style="font-size:22px;font-weight:600;">{{ alt }} ft</div>
          </div>

          <div>
            <div style="font-size:11px;opacity:0.6;text-transform:uppercase;">Ground Speed</div>
            <div style="font-size:22px;font-weight:600;">{{ gs }} kts</div>
          </div>

          <div>
            <div style="font-size:11px;opacity:0.6;text-transform:uppercase;">Aircraft</div>
            <div style="font-size:20px;font-weight:600;">{{ aircraft }}</div>
          </div>

        </div>
      </div>

      <div style="text-align:center;">
        <img src="{{ logo_url }}" style="width:120px;max-height:120px;object-fit:contain;" />
        <div style="font-size:13px;opacity:0.7;margin-top:6px;text-transform:uppercase;">
          {{ airline_label }}
        </div>

        {% if mode == 'most' %}
        <div style="font-size:10px;opacity:0.5;margin-top:3px;text-transform:uppercase;">
          MOST TRACKED FLIGHT
        </div>
        {% endif %}
      </div>

    </div>

  {% endif %}
  </div>
